# [오류 일지] 주문개선: 재고 안정화 작업

### 참고
[주문 개선하기: 재고 업데이트 안정화](https://github.com/ejoongseok/blog/blob/main/%EA%B0%9C%EB%B0%9C%EC%9D%BC%EC%A7%80/4.%EC%A3%BC%EB%AC%B8%20%EA%B0%9C%EC%84%A0%ED%95%98%EA%B8%B0%3A%20%EC%9E%AC%EA%B3%A0%20%EC%97%85%EB%8D%B0%EC%9D%B4%ED%8A%B8%20%EC%95%88%EC%A0%95%ED%99%94.md)

## 하인리히의 법칙: 1:29:300 
하인리히의 법칙에 따르면, 큰 사고가 발생하기 전에는 경미한 사고가 수십 차례, 그리고 수백 번의 징후가 나타난다고 한다.   
재고 안정화 작업이 끝나고 서비스를 운영한 지 2주 정도 지나자, 특정 상품에 재고가 부족해 주문이 안 되는 문제가 발생했다.  

---

먼저, DB의 재고와 레디스의 재고가 불일치하는 문제를 의심했다.   

그러나, 여러 차례 확인한 결과 재고 데이터의 쓰기에서 오류가 발생하지 않았음을 확인했다.  

다음으로는 문제가 발생하지 않은 다른 상품들로 디버그를 진행하며, 조회 과정에서 오류가 있는지 확인해 보았다. 그러나, 이 역시 문제가 없었다.  

하지만, 문제 상품을 조회해본 결과, 특정 상품 구조에서만 재고가 틀어지는 일이 발생하는 것을 발견했다.  

원인은 4000줄이 넘는 레거시 코드에 레디스 재고 조회를 위해 추가한 4개의 코드 중, 하나의 매핑이 잘못되었기 때문이었다.   
이로 인해 특정 상품의 재고 조회가 틀어졌고, 그 결과 특정 상품에서만 문제가 발생했다.  

```
// 추가한 코드 예시
1500 line | getRedisQty(aParam)  // 올바른 매핑
2000 line | getRedisQty(bParam)  // 올바른 매핑
2500 line | getRedisQty(bParam)  // 잘못된 매핑, 원래는 aParam이어야 함
3000 line | getRedisQty(bParam)  // 올바른 매핑
```

Git History를 확인해 보니, 운영 적용 3주 전에 해당 코드를 추가할 때 실수로 잘못된 매핑을 했고, 이를 발견하지 못한 것이었다.    
작업 당시에는 오전 10시로, 멀쩡한 정신에 작업을 했음에도 불구하고 실수를 저지른 셈이었다.   

더 큰 문제는, 이후 충분한 모니터링 기간을 가졌음에도 불구하고 이를 발견하지 못했다는 것이다.   
원래 레디스 재고를 실제 사용하기 전에 DB 재고와 레디스 재고가 일치하지 않는지 확인하기 위해 로그를 심어두었으나,   
레디스 재고가 실시간으로 반영되면서 대부분 상품에서 DB 재고와 1~2개씩 차이가 나면서 로그가 너무 많이 찍혀서   
로그가 노이즈로 작용해 정작 중요한 로그를 못본것이다.  

결국, 이런 무성의한 로그 때문에 모니터링 기간이라는 골든타임을 놓치고 장애가 운영으로 전파되었다.   

조금 더 성심성의껏 로그를 심었더라면, 운영에 전파되기 전에 발견할 수 있었을 것이다.  

이번 일을 통해, 단순한 확인 용도로 로그를 심는 것이 아니라, 보다 신중하고 효과적으로 로그를 심는 것이 얼마나 중요한지 깨달았다.  
레거시와 신규로 dual Write를 하는 데이터는 어느 오차 범위까지 문제가 아니라고 볼지 기준을 정하는것을 먼저하는것이 중요한것 같다.
이후 다음과 같이 로그를 심는 기준을 개선했다.  
``` java
if(Math.abs(dbQty - redisQty) > 10) { 
    log.warn()
}
if(Math.abs(dbQty - redisQty) > 30) { 
    log.error()
}
```
