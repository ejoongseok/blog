# 신규 장바구니 페이지 안전하게 오픈하기

2024년 3분기에 팀에서 리뉴얼한 신규 장바구니 페이지를 안전하게 오픈하기 위해 적용했던 카나리 오픈 전략에 대해서 적어보도록 하겠습니다.

## 이전 글
- [1.대량 상품 출고 데이터 처리](https://github.com/ejoongseok/blog/blob/main/%EA%B0%9C%EB%B0%9C%EC%9D%BC%EC%A7%80/1.%EB%8C%80%EB%9F%89%20%EC%83%81%ED%92%88%20%EC%B6%9C%EA%B3%A0%20%EB%8D%B0%EC%9D%B4%ED%84%B0%20%EC%B2%98%EB%A6%AC.md)
- [2.서비스간 의존성 격리: 트랜잭셔널 아웃박스 패턴](https://github.com/ejoongseok/blog/blob/main/%EA%B0%9C%EB%B0%9C%EC%9D%BC%EC%A7%80/2.%EC%84%9C%EB%B9%84%EC%8A%A4%EA%B0%84%20%EC%9D%98%EC%A1%B4%EC%84%B1%20%EA%B2%A9%EB%A6%AC%3A%20%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%94%EB%84%90%20%EC%95%84%EC%9B%83%EB%B0%95%EC%8A%A4%20%ED%8C%A8%ED%84%B4.md)
- [3.주문 개선하기: 시퀀스 테이블 페이드아웃](https://github.com/ejoongseok/blog/blob/main/%EA%B0%9C%EB%B0%9C%EC%9D%BC%EC%A7%80/3.%EC%A3%BC%EB%AC%B8%20%EA%B0%9C%EC%84%A0%ED%95%98%EA%B8%B0%3A%20%EC%8B%9C%ED%80%80%EC%8A%A4%20%ED%85%8C%EC%9D%B4%EB%B8%94%20%ED%8E%98%EC%9D%B4%EB%93%9C%EC%95%84%EC%9B%83.md)
- [4.재고 개선하기: 재고 업데이트 안정화](https://github.com/ejoongseok/blog/blob/main/%EA%B0%9C%EB%B0%9C%EC%9D%BC%EC%A7%80/4.%EC%A3%BC%EB%AC%B8%20%EA%B0%9C%EC%84%A0%ED%95%98%EA%B8%B0%3A%20%EC%9E%AC%EA%B3%A0%20%EC%97%85%EB%8D%B0%EC%9D%B4%ED%8A%B8%20%EC%95%88%EC%A0%95%ED%99%94.md)

## 문제 상황

최근 재고 개선 과제를 마무리한 후 뒤늦게 커머스 장바구니의 신규 개편 작업에 참여하게 되었다.  
케타포의 기존 장바구니는 신규 기능을 추가하거나 변경하기 어려운 구조의 레거시 시스템이었다.  
이를 해결하기 위해 테이블을 유연한 구조로 새로 만들고, 장바구니 페이지 또한 새로운 요구사항을 충족할 수 있도록 리뉴얼하여 오픈하기로 했다.  

팀에서는 새로운 장바구니의 요구사항에 맞게 API를 개발한 후,  
언제든 기존 장바구니로 롤백할 수 있도록 신규 장바구니 API에 레거시 장바구니의 데이터를 Dual Write 하도록 적용했다.

장바구니 데이터는 마이페이지, 주문, 결제 등 예상보다 여러 곳에서 사용되고 있었다.  
리뉴얼된 장바구니가 제대로 동작하지 않을 경우 서비스에 문제가 될 수 있는 상황이었다.  
고객의 구매 과정에 직접적인 영향을 미치는 부분이므로, 신중한 접근이 필요했다.

## 카나리 오픈 전략의 필요성

기존 장바구니에서 새로운 장바구니로 한 번에 전환을 진행하기에는 리스크가 있었다.  
우리가 의도한 대로 동작해서 장애가 발생하지 않는다면 다행이지만, 발견하지 못한 버그가 있을 수 있기 때문에 위험 부담이 있었고, 안전장치가 필요했다.  
논의 끝에, 케타포에서 운영하는 여러 상점 중 **특정 상점**의 **일부 사용자**에게 신규 장바구니를 점진적으로 오픈하는 '**카나리 오픈**' 전략을 채택했다.  

이 전략은 사용자에게 새로운 기능을 단계적으로 제공함으로써 예상치 못한 문제가 발생할 경우 빠르게 대응할 수 있는 유연한 방식이었다.  
이 시점에서 나는 재고 개선 작업을 끝내고 장바구니 개선 작업에 참여하게 되었으며, 신규 장바구니의 카나리 오픈 기능을 개발하는 업무를 맡게 되었다.

## 프론트엔드 구현 플로우

신규 장바구니는 우선 로그인한 사용자에게만 제공하기로 했다.  
로그인하지 않은 사용자까지 고려하기에는 얻을 수 있는 이점에 비해 복잡도가 지나치게 높아졌기 때문이었다.  

![image](https://github.com/user-attachments/assets/b0f9bbff-2697-48e9-998f-9b465b6a5ed8)

## 백엔드 구현 플로우

백엔드에서는 프론트엔드에서 Canary API를 호출하면 사용자의 세션 ID를 활용해 비로그인 사용자의 신규 장바구니 활성 여부를 판단했다.  
비로그인 사용자의 신규 장바구니가 활성화되어 있어서 로그인을 해야 하는 경우, 해당 사용자는 로그인 이후에 신규 장바구니를 사용할 수 있게 되는 방식이었다.  

또한, 로그인 사용자의 신규 장바구니가 활성화되었다고 하더라도, 신규 장바구니를 사용하다가 예외가 발생하거나, 신규 장바구니 데이터에 문제가 있을 경우 관리자가 직접 사용자의 신규 장바구니 활성 여부를 비활성화할 수 있어야 했다.  
그리고 신규 장바구니가 비활성화되어 있더라도 Canary 활성 비율이 커질 경우 해당 사용자가 여전히 비활성에 속하는지도 판단해야 했다.  
그 다음에는 신규 장바구니가 활성화되더라도 레거시 장바구니와 dual write한 데이터를 검증해야 했다.  
옛날에 레거시 장바구니에 담아놨던 데이터가 신규 장바구니에서는 보이지 않는 엣지 케이스도 존재할 수 있었기 때문이다.  

<p align="center"><img src="https://github.com/user-attachments/assets/a4b92216-6fba-4736-b24b-78b75dc50263"></img></p>

## 테스트 전략

생각보다 요구사항이 까다로웠지만 처음에는 애플리케이션 코드를 먼저 작성해보려고 했다.  
하지만 당장 좋은 API 구조가 떠오르지 않았기 때문에 테스트 리스트를 먼저 만들고 가장 쉬운 것부터 하나씩 테스트가 통과하도록 절차적인 방식으로 구현했다.  
복잡한 로직과 요구사항을 효과적으로 구현하기 위해 테스트 목록을 먼저 작성하고, 이를 기반으로 구현을 진행했다.  
이렇게 함으로써 작업 진행 상황을 명확히 파악할 수 있었고, 예상치 못한 문제를 조기에 발견할 수 있었다.  

```
/*
Test List
0. new-cart-force-on 피처 플래그가 활성화된 경우, 무조건 신규 장바구니를 활성화한다.
    * new-cart-force-on 피처 플래그가 비활성화되어 있고 new-cart-on 피처 플래그가 비활성화되어 있는 경우, 신규 카트 피처 플래그를 비활성화한다.
1. 비로그인 사용자일 경우:
    * 세션 ID를 통해 신규 장바구니의 활성 여부를 판단한다.
    * 신규 장바구니가 활성인 경우, 이후 로그인한 사용자가 신규 장바구니를 활성화한다.
2. 로그인 사용자일 경우:
    * 관리자에 의해 강제로 설정된 경우, 활성화 비율과 상관없이 저장된 설정을 반환한다.
    * 그렇지 않은 경우, 사용자에게 활성 여부가 설정된 이후 활성화 비율이 업데이트되었는지 확인한다.
    * 활성화 비율이 업데이트된 경우 사용자의 활성 여부를 다시 검증한 뒤 활성 여부를 반환한다.
    * 그렇지 않은 경우, 활성화 비율이 100% 이상인지 확인한다.
    * 활성화 비율이 100% 이상인 경우, 신규 장바구니를 활성화한다.
    * 활성화 비율이 100% 미만인 경우, 레거시 장바구니와 신규 장바구니가 일치하는지 확인한다.
    * 일치하는 경우, 사용자의 신규 장바구니 활성 여부를 판단한다.
        * 활성인 경우, 신규 장바구니를 활성화한다.
        * 비활성인 경우, 레거시 장바구니를 활성화한다.
    * 일치하지 않는 경우, 레거시 장바구니를 활성화한다.
 */
class CanaryReleaseTest {...}

```

테스트 목록을 먼저 작성한 뒤 테스트 케이스를 하나씩 통과시켜보니, 작업이 얼마나 진행되었고 얼마나 남았는지 예측할 수 있었다.  
복잡한 로직일수록 test first가 선행되어야 하는 것 같다.  
절차적으로 코드를 작성해서 모든 요구사항을 충족시킨 뒤 리팩터링 작업은 ChatGPT를 활용했다.  
ChatGPT가 요구사항과 동작이 달라지는 방식으로 코드를 제안할 때도 있었지만, 테스트 케이스가 있었기 때문에 금방 오류를 찾고 수월하게 진행할 수 있었다.  

## 성과

카나리 전략을 통해 신규 장바구니 페이지 리뉴얼의 리스크를 최소화할 수 있었다.

테스트 기반 접근법을 통해 기능이 예상대로 동작하는 것을 확인할 수 있었고,   
절차적인 프로그래밍 방식으로 빠르게 기능을 배포하여 팀 내 의사결정자들이 새로운 기능을 직접 사용해볼 수 있도록 했다.  

이번 작업은 최대한 빨리 의사결정자들이 새로운 기능을 확인할 수 있도록 하는 것이 중요했다.  
그렇기 때문에 빠른 배포와 실질적인 기능 동작을 우선시했다.  

이를 통해 최소한의 노력으로 최대의 효율을 내보는 경험을 할 수 있었다.  
복잡한 로직일수록 테스트 목록을 먼저 작성하고 하나씩 구현해나가는 것이 빠른 길이라는 점을 이번 프로젝트를 통해 다시 한번 깨달았다.  
